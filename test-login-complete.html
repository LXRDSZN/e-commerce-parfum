<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Login Completo - √âlite Perfumer√≠a</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="fas fa-bug me-2"></i>Test Completo del Sistema de Login</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Instrucciones:</h6>
                            <ol>
                                <li>Primero limpia los datos</li>
                                <li>Prueba el login con las cuentas de test</li>
                                <li>Verifica que el nombre se muestre correctamente</li>
                                <li>Ve al index.html para verificar</li>
                            </ol>
                        </div>

                        <!-- Status -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h6 class="card-title"><i class="fas fa-info-circle me-2"></i>Estado del Sistema</h6>
                                <div id="systemStatus">Cargando...</div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <button class="btn btn-warning w-100" onclick="clearAllData()">
                                    <i class="fas fa-trash me-2"></i>Limpiar Todo
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-success w-100" onclick="testClientLogin()">
                                    <i class="fas fa-user me-2"></i>Login Cliente
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-danger w-100" onclick="testAdminLogin()">
                                    <i class="fas fa-shield-alt me-2"></i>Login Admin
                                </button>
                            </div>
                        </div>

                        <!-- User Display -->
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title"><i class="fas fa-user-circle me-2"></i>Usuario Actual</h6>
                                <div class="user-menu border rounded p-3">
                                    <!-- This will be updated by authSystem -->
                                </div>
                                <div class="mt-3">
                                    <small id="userDetails" class="text-muted"></small>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <div class="card mt-4">
                            <div class="card-body text-center">
                                <h6>Navegaci√≥n de Prueba</h6>
                                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                    <a href="index.html" class="btn btn-primary">
                                        <i class="fas fa-home me-2"></i>Ir a Index.html
                                    </a>
                                    <a href="pages/login.html" class="btn btn-success">
                                        <i class="fas fa-sign-in-alt me-2"></i>P√°gina Login
                                    </a>
                                    <button class="btn btn-secondary" onclick="checkAuthSystem()">
                                        <i class="fas fa-sync me-2"></i>Refresh Status
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Debug Log -->
                        <div class="card mt-4">
                            <div class="card-body">
                                <h6>Debug Log</h6>
                                <pre id="debugLog" class="bg-dark text-white p-3 rounded" style="font-size: 0.8rem; max-height: 200px; overflow-y: auto;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        let debugLog = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${message}`);
            document.getElementById('debugLog').textContent = debugLog.slice(-10).join('\n');
        }

        function clearAllData() {
            log('üßπ Limpiando todos los datos...');
            localStorage.clear();
            sessionStorage.clear();
            
            // Reset auth system
            if (typeof authSystem !== 'undefined') {
                authSystem.logout();
            }
            
            log('‚úÖ Datos limpiados');
            updateStatus();
        }

        function testClientLogin() {
            log('üîÑ Probando login de cliente...');
            
            const result = authSystem.authenticate('cliente@email.com', 'cliente123');
            log(`üìß Auth result: ${JSON.stringify(result)}`);
            
            if (result.success) {
                authSystem.login(result.user, false);
                log(`‚úÖ Login exitoso: ${result.user.nombre} ${result.user.apellido}`);
            } else {
                log(`‚ùå Login fall√≥: ${result.error}`);
            }
            
            updateStatus();
        }

        function testAdminLogin() {
            log('üîÑ Probando login de admin...');
            
            const result = authSystem.authenticate('admin@eliteperfumeria.com', 'admin123');
            log(`üìß Auth result: ${JSON.stringify(result)}`);
            
            if (result.success) {
                authSystem.login(result.user, false);
                log(`‚úÖ Login exitoso: ${result.user.nombre} ${result.user.apellido}`);
            } else {
                log(`‚ùå Login fall√≥: ${result.error}`);
            }
            
            updateStatus();
        }

        function checkAuthSystem() {
            log('üîç Verificando sistema de auth...');
            updateStatus();
        }

        function updateStatus() {
            const statusDiv = document.getElementById('systemStatus');
            const userDetailsDiv = document.getElementById('userDetails');
            
            if (typeof authSystem === 'undefined') {
                statusDiv.innerHTML = '<span class="text-danger">‚ùå AuthSystem no est√° cargado</span>';
                return;
            }

            const isLoggedIn = authSystem.isLoggedIn();
            const currentUser = authSystem.getCurrentUser();
            
            if (isLoggedIn && currentUser) {
                const fullName = `${currentUser.nombre} ${currentUser.apellido || ''}`.trim();
                statusDiv.innerHTML = `
                    <span class="text-success">‚úÖ Usuario logueado: <strong>${fullName}</strong></span><br>
                    <small>Email: ${currentUser.email} | Rol: ${currentUser.role}</small>
                `;
                
                userDetailsDiv.innerHTML = `
                    <strong>Detalles completos:</strong><br>
                    <code>${JSON.stringify(currentUser, null, 2)}</code>
                `;
                
                log(`üë§ Usuario activo: ${fullName} (${currentUser.role})`);
            } else {
                statusDiv.innerHTML = '<span class="text-warning">‚ö†Ô∏è No hay usuario logueado</span>';
                userDetailsDiv.innerHTML = 'No hay datos de usuario';
                log('üë§ No hay usuario logueado');
            }

            // Force UI update
            if (authSystem.updateUserUI) {
                authSystem.updateUserUI();
                log('üîÑ UI actualizada');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ P√°gina cargada');
            
            setTimeout(() => {
                log('üì± Inicializando sistema...');
                updateStatus();
                
                // Check if there's already a user
                const stored = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
                if (stored) {
                    log(`üì¶ Datos encontrados en storage: ${stored.substring(0, 50)}...`);
                }
            }, 500);
        });
    </script>
</body>
</html>