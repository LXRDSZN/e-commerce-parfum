<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti칩n de Usuarios - 칄lite Perfumer칤a Admin</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Admin CSS -->
    <link rel="stylesheet" href="../css/admin.css">

</head>
<body>
    <!-- Sidebar -->
    <nav class="admin-sidebar" id="adminSidebar">
        <div class="text-center py-4 border-bottom border-light border-opacity-25">
            <i class="fas fa-gem text-white fs-2 mb-2"></i>
            <h5 class="text-white mb-0">칄lite Admin</h5>
        </div>
        
        <ul class="nav flex-column sidebar-nav">
            <li class="nav-item">
                <a class="nav-link" href="dashboard.html">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="productos.html">
                    <i class="fas fa-spray-can me-2"></i>Perfumes
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="usuarios.html">
                    <i class="fas fa-users me-2"></i>Usuarios
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../index.html">
                    <i class="fas fa-store me-2"></i>Ver Tienda
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-danger" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi칩n
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="admin-main-content">
        <!-- Header -->
        <header class="admin-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0 fw-bold">游논 Gesti칩n de Usuarios</h4>
                    <small class="text-muted">Administrar cuentas de usuarios</small>
                </div>
                
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-outline-primary btn-sm" onclick="loadUsers()">
                        <i class="fas fa-sync-alt me-2"></i>Actualizar
                    </button>
                    
                    <div class="dropdown" style="z-index: 9999;">
                        <button class="btn btn-link text-dark dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle fs-4 me-2"></i>
                            <div class="text-start">
                                <div class="fw-bold" id="adminUserName">Administrador</div>
                                <small class="text-muted">Admin</small>
                            </div>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" style="z-index: 9999;">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Perfil</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cogs me-2"></i>Configuraci칩n</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi칩n</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="container-fluid p-4">
            <!-- Stats Cards -->
            <div class="row g-4 mb-4">
                <div class="col-xl-3 col-md-6">
                    <div class="stats-card customers">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-users fa-2x text-primary"></i>
                            </div>
                            <div>
                                <h3 class="fw-bold mb-0" id="totalCustomers">0</h3>
                                <p class="text-muted mb-0">Clientes</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6">
                    <div class="stats-card admins">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-user-shield fa-2x text-danger"></i>
                            </div>
                            <div>
                                <h3 class="fw-bold mb-0" id="totalAdmins">0</h3>
                                <p class="text-muted mb-0">Administradores</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6">
                    <div class="stats-card active">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-user-check fa-2x text-success"></i>
                            </div>
                            <div>
                                <h3 class="fw-bold mb-0" id="activeUsers">0</h3>
                                <p class="text-muted mb-0">Activos</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6">
                    <div class="stats-card inactive">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-user-times fa-2x text-warning"></i>
                            </div>
                            <div>
                                <h3 class="fw-bold mb-0" id="inactiveUsers">0</h3>
                                <p class="text-muted mb-0">Inactivos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Buscar usuarios...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="roleFilter">
                        <option value="">Todos los roles</option>
                        <option value="customer">Clientes</option>
                        <option value="admin">Administradores</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="">Todos los estados</option>
                        <option value="true">Activos</option>
                        <option value="false">Inactivos</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Limpiar
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-info w-100" onclick="exportUsers()">
                        <i class="fas fa-download me-1"></i>Exportar
                    </button>
                </div>
            </div>

            <!-- Users Grid -->
            <div class="row g-4" id="usersContainer">
                <!-- Users will be loaded here -->
            </div>

            <!-- Pagination -->
            <nav class="mt-5" id="paginationContainer">
                <!-- Pagination will be loaded here -->
            </nav>
        </div>
    </main>

    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Agregar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Nombre *</label>
                                <input type="text" class="form-control" id="userName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Apellido *</label>
                                <input type="text" class="form-control" id="userLastName" required>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Email *</label>
                                <input type="email" class="form-control" id="userEmail" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Rol *</label>
                                <select class="form-select" id="userRole" required>
                                    <option value="">Seleccionar rol</option>
                                    <option value="customer">Cliente</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Tel칠fono</label>
                                <input type="tel" class="form-control" id="userPhone">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Estado</label>
                                <select class="form-select" id="userStatus">
                                    <option value="true">Activo</option>
                                    <option value="false">Inactivo</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label fw-bold">Direcci칩n</label>
                            <textarea class="form-control" id="userAddress" rows="2"></textarea>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Ciudad</label>
                                <input type="text" class="form-control" id="userCity">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">C칩digo Postal</label>
                                <input type="text" class="form-control" id="userZip">
                            </div>
                        </div>
                        
                        <div class="mt-3" id="passwordSection">
                            <label class="form-label fw-bold">Contrase침a *</label>
                            <input type="password" class="form-control" id="userPassword" required>
                            <small class="form-text text-muted">M칤nimo 6 caracteres</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">
                        <i class="fas fa-save me-2"></i>Guardar Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let allUsers = [];
        let filteredUsers = [];
        let currentPage = 1;
        let usersPerPage = 12;

        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadUsers();
            setupFilters();
        });

        function checkAdminAuth() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser') || '{}');
            
            if (!currentUser.email || currentUser.role !== 'admin') {
                alert('Acceso denegado. Requiere permisos de administrador.');
                window.location.href = '../pages/login.html';
                return;
            }
        }

        function loadUsers() {
            // Get registered users
            const registeredUsers = authSystem.getStoredUsers();
            
            // Add default admin and customer accounts
            const defaultUsers = [
                {
                    id: 1,
                    nombre: 'Administrador',
                    apellido: 'Sistema',
                    email: 'admin@eliteperfumeria.com',
                    role: 'admin',
                    activo: true,
                    fecha_registro: new Date().toISOString(),
                    telefono: '',
                    direccion: '',
                    ciudad: ''
                },
                {
                    id: 2,
                    nombre: 'Cliente',
                    apellido: 'Prueba',
                    email: 'cliente@email.com',
                    role: 'customer',
                    activo: true,
                    fecha_registro: new Date().toISOString(),
                    telefono: '',
                    direccion: '',
                    ciudad: ''
                }
            ];

            allUsers = [...defaultUsers, ...registeredUsers];
            filteredUsers = [...allUsers];
            
            updateStats();
            displayUsers();
        }

        function updateStats() {
            const totalCustomers = allUsers.filter(u => u.role === 'customer').length;
            const totalAdmins = allUsers.filter(u => u.role === 'admin').length;
            const activeUsers = allUsers.filter(u => u.activo === true).length;
            const inactiveUsers = allUsers.filter(u => u.activo === false).length;

            document.getElementById('totalCustomers').textContent = totalCustomers;
            document.getElementById('totalAdmins').textContent = totalAdmins;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('inactiveUsers').textContent = inactiveUsers;
        }

        function displayUsers() {
            const container = document.getElementById('usersContainer');
            const startIndex = (currentPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const usersToShow = filteredUsers.slice(startIndex, endIndex);

            if (usersToShow.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No se encontraron usuarios</h5>
                        <p class="text-muted">Intenta cambiar los filtros</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = usersToShow.map(user => `
                <div class="col-xl-4 col-lg-6">
                    <div class="card user-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-start mb-3">
                                <div class="user-avatar me-3">
                                    ${user.nombre.charAt(0).toUpperCase()}${user.apellido?.charAt(0)?.toUpperCase() || ''}
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-1">${user.nombre} ${user.apellido || ''}</h6>
                                    <p class="text-muted mb-1 small">${user.email}</p>
                                    <div class="d-flex gap-2">
                                        <span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-primary'}">${user.role === 'admin' ? 'Admin' : 'Cliente'}</span>
                                        <span class="badge ${user.activo ? 'bg-success' : 'bg-warning'}">${user.activo ? 'Activo' : 'Inactivo'}</span>
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#" onclick="viewUser(${user.id})">
                                            <i class="fas fa-eye me-2"></i>Ver Detalles</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="editUser(${user.id})">
                                            <i class="fas fa-edit me-2"></i>Editar</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item ${user.activo ? 'text-warning' : 'text-success'}" href="#" onclick="toggleUserStatus(${user.id})">
                                            <i class="fas fa-${user.activo ? 'user-times' : 'user-check'} me-2"></i>${user.activo ? 'Desactivar' : 'Activar'}</a></li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="small text-muted">
                                <p class="mb-1"><i class="fas fa-phone me-2"></i>${user.telefono || 'No especificado'}</p>
                                <p class="mb-1"><i class="fas fa-map-marker-alt me-2"></i>${user.ciudad || 'No especificada'}</p>
                                <p class="mb-0"><i class="fas fa-calendar me-2"></i>Registro: ${new Date(user.fecha_registro).toLocaleDateString()}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            setupPagination();
        }

        function setupPagination() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            const container = document.getElementById('paginationContainer');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let pagination = '<ul class="pagination justify-content-center">';
            
            pagination += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <button class="page-link" onclick="goToPage(${currentPage - 1})">Anterior</button>
                </li>
            `;
            
            for (let i = 1; i <= totalPages; i++) {
                pagination += `
                    <li class="page-item ${currentPage === i ? 'active' : ''}">
                        <button class="page-link" onclick="goToPage(${i})">${i}</button>
                    </li>
                `;
            }
            
            pagination += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <button class="page-link" onclick="goToPage(${currentPage + 1})">Siguiente</button>
                </li>
            `;
            
            pagination += '</ul>';
            container.innerHTML = pagination;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayUsers();
        }

        function setupFilters() {
            const searchInput = document.getElementById('searchInput');
            const roleFilter = document.getElementById('roleFilter');
            const statusFilter = document.getElementById('statusFilter');

            [searchInput, roleFilter, statusFilter].forEach(element => {
                element.addEventListener('change', applyFilters);
                element.addEventListener('keyup', applyFilters);
            });
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const role = document.getElementById('roleFilter').value;
            const status = document.getElementById('statusFilter').value;

            filteredUsers = allUsers.filter(user => {
                const matchesSearch = !search || 
                    user.nombre.toLowerCase().includes(search) ||
                    user.apellido?.toLowerCase().includes(search) ||
                    user.email.toLowerCase().includes(search);
                
                const matchesRole = !role || user.role === role;
                const matchesStatus = !status || user.activo.toString() === status;

                return matchesSearch && matchesRole && matchesStatus;
            });

            currentPage = 1;
            displayUsers();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('roleFilter').value = '';
            document.getElementById('statusFilter').value = '';
            
            filteredUsers = [...allUsers];
            currentPage = 1;
            displayUsers();
        }

        function openAddUserModal() {
            document.getElementById('userModalTitle').textContent = 'Agregar Usuario';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('passwordSection').style.display = 'block';
            document.getElementById('userPassword').required = true;
        }

        function editUser(userId) {
            const user = allUsers.find(u => u.id == userId);
            if (!user) return;

            document.getElementById('userModalTitle').textContent = 'Editar Usuario';
            document.getElementById('userId').value = userId;
            document.getElementById('userName').value = user.nombre;
            document.getElementById('userLastName').value = user.apellido || '';
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userPhone').value = user.telefono || '';
            document.getElementById('userStatus').value = user.activo.toString();
            document.getElementById('userAddress').value = user.direccion || '';
            document.getElementById('userCity').value = user.ciudad || '';
            document.getElementById('userZip').value = user.codigo_postal || '';

            document.getElementById('passwordSection').style.display = 'none';
            document.getElementById('userPassword').required = false;

            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function toggleUserStatus(userId) {
            const user = allUsers.find(u => u.id == userId);
            if (!user) return;

            const action = user.activo ? 'desactivar' : 'activar';
            if (confirm(`쮼st치s seguro de que deseas ${action} este usuario?`)) {
                user.activo = !user.activo;
                
                // Update in storage if not a default user
                if (userId > 2) {
                    const storedUsers = authSystem.getStoredUsers();
                    const index = storedUsers.findIndex(u => u.id == userId);
                    if (index !== -1) {
                        storedUsers[index].activo = user.activo;
                        localStorage.setItem('registeredUsers', JSON.stringify(storedUsers));
                    }
                }
                
                updateStats();
                displayUsers();
                showNotification(`Usuario ${action} exitosamente`, 'success');
            }
        }

        function saveUser() {
            const form = document.getElementById('userForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const userId = document.getElementById('userId').value;
            const isEditing = !!userId;

            const userData = {
                id: isEditing ? parseInt(userId) : Date.now(),
                nombre: document.getElementById('userName').value,
                apellido: document.getElementById('userLastName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value,
                telefono: document.getElementById('userPhone').value,
                activo: document.getElementById('userStatus').value === 'true',
                direccion: document.getElementById('userAddress').value,
                ciudad: document.getElementById('userCity').value,
                codigo_postal: document.getElementById('userZip').value,
                fecha_registro: new Date().toISOString()
            };

            if (!isEditing) {
                userData.password = document.getElementById('userPassword').value;
            }

            if (isEditing) {
                const index = allUsers.findIndex(u => u.id == userId);
                if (index !== -1) {
                    allUsers[index] = { ...allUsers[index], ...userData };
                }
            } else {
                allUsers.push(userData);
            }

            // Update storage for non-default users
            const storedUsers = allUsers.filter(u => u.id > 2);
            localStorage.setItem('registeredUsers', JSON.stringify(storedUsers));

            loadUsers();
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            
            showNotification(
                isEditing ? 'Usuario actualizado exitosamente' : 'Usuario creado exitosamente',
                'success'
            );
        }

        function exportUsers() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Nombre,Apellido,Email,Rol,Estado,Tel칠fono,Ciudad,Fecha Registro\n" +
                allUsers.map(user => 
                    `"${user.nombre}","${user.apellido || ''}","${user.email}","${user.role}","${user.activo ? 'Activo' : 'Inactivo'}","${user.telefono || ''}","${user.ciudad || ''}","${new Date(user.fecha_registro).toLocaleDateString()}"`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "usuarios_elite_perfumeria.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showNotification(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) alert.remove();
            }, 5000);
        }

        function logout() {
            if (confirm('쮼st치s seguro de que deseas cerrar sesi칩n?')) {
                localStorage.removeItem('currentUser');
                sessionStorage.removeItem('currentUser');
                window.location.href = '../pages/login.html';
            }
        }
    </script>
</body>
</html>